/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements. 
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[16],{132:function(e,t,a){"use strict";a.d(t,"b",(function(){return i})),a.d(t,"a",(function(){return o}));var r=a(24),n=a.n(r);function i(e,t,a,r){if(Array.isArray(e)){if(1===e.length)return o(e[0],t,a,r);return`[${e.map((e=>o(e,t,void 0,r)))}]`}return o(e,t,a,r)}function o(e,t,a,r){if(null==e)return"";if("time_of_week"===t){const t=void 0!==r&&void 0!==r.timestamp?new Date(r.timestamp):new Date,a=n.a.utc(t).startOf("week").add(e,"s");return n()(a.valueOf()).format("ddd HH:mm")}if("time_of_day"===t){const t=void 0!==r&&void 0!==r.timestamp?new Date(r.timestamp):new Date,a=n.a.utc(t).startOf("day").add(e,"s");return n()(a.valueOf()).format("HH:mm")}if(void 0!==a)return a.convert(e,"text");{const t=Math.abs(e);if(t>=1e4||t===Math.floor(t))return void 0!==a?a.convert(e,"text"):Number(e.toFixed(0));if(t>=10)return Number(e.toFixed(1));{let t;return t=e>0?Math.pow(10,3-Math.floor(Math.log(e)/Math.LN10)-1):Math.pow(10,3-Math.floor(Math.log(-1*e)/Math.LN10)-1),Math.round(e*t)/t}}}},136:function(e,t,a){"use strict";a.d(t,"a",(function(){return c}));var r=a(5),n=a.n(r),i=a(80),o=a(96),s=a(83);const c=new class FieldFormatService{constructor(){n()(this,"indexPatternIdsByJob",{}),n()(this,"formatsByJob",{})}async populateFormats(e){(await Promise.all(e.map((async e=>{const t=s.a.getJob(e);return{jobId:e,dataViewId:await Object(o.d)(t.datafeed_config.indices.join(","))}})))).forEach((({jobId:e,dataViewId:t})=>{null!==t&&(this.indexPatternIdsByJob[e]=t)}));const t=e.map((e=>Promise.all([this.getFormatsForJob(e)])));try{return(await Promise.all(t)).forEach(((t,a)=>{this.formatsByJob[e[a]]=t[0]})),this.formatsByJob}catch(e){return console.log("Error populating field formats:",e),{formats:{},error:e}}}getFieldFormat(e,t){if(this.formatsByJob.hasOwnProperty(e))return this.formatsByJob[e][t]}getFieldFormatFromIndexPattern(e,t,a){let r;if("cardinality"!==a){const a=e.fields.getByName(t);void 0!==a&&(r=e.getFormatterForField(a))}return r}getFormatsForJob(e){return new Promise(((t,a)=>{const r=s.a.getJob(e).analysis_config.detectors||[],n=[],c=this.indexPatternIdsByJob[e];void 0!==c?Object(o.c)(c).then((e=>{const a=e.fields;r.forEach((t=>{const r=Object(i.q)(t.function);if(void 0!==t.field_name&&"cardinality"!==r){const r=a.getByName(t.field_name);void 0!==r&&(n[t.detector_index]=e.getFormatterForField(r))}})),t(n)})).catch((e=>{a(e)})):t(n)}))}}},265:function(e,t,a){"use strict";a.d(t,"a",(function(){return n}));var r=a(150);function n(e,t,a){const n=["kuery"===t.language?Object(r.f)(Object(r.d)(t.query)):Object(r.e)(t.query)],i=[];for(const t of e){if(t.meta.disabled||void 0!==a&&t.meta.controlledBy===a)continue;const{meta:{negate:e,type:r,key:o}}=t;let s=t.query;void 0===s&&"exists"===r&&(s={exists:{field:o}}),s&&(e?i.push(s):n.push(s))}return{bool:{must:n,must_not:i}}}},266:function(e,t,a){"use strict";a.d(t,"a",(function(){return s}));var r=a(25),n=a(28),i=a(8),o=a(29);function s(e,t,a){return e.pipe(Object(n.pluck)("jobIds"),Object(n.distinctUntilChanged)(i.isEqual),Object(n.switchMap)((e=>t.getJobs$(e))),Object(n.map)((e=>e.map((e=>{const t=Object(o.a)(e.analysis_config.bucket_span);return{id:e.job_id,selected:!0,bucketSpanSeconds:t.asSeconds()}})))),Object(n.catchError)((e=>{var t;return a(null!==(t=e.body)&&void 0!==t?t:e),Object(r.of)(void 0)})))}},767:function(e,t,a){"use strict";a.r(t),a.d(t,"EmbeddableAnomalyChartsContainer",(function(){return F}));var r=a(16),n=a.n(r),i=a(44),o=a(45),s=a(8),c=a(25),d=a(28),l=a(110),u=a(47),b=a(107),m=a(85),f=a(265),h=a(266);var j=a(75),O=a.n(j),v=a(2),g=a(387),p=a(139),y=a(12);const x=v.i18n.translate("xpack.ml.explorer.charts.dashboardTooManyBucketsDescription",{defaultMessage:"This selection contains too many buckets to be displayed. You should shorten the time range of the view."}),w=({id:e,chartsData:t,showCharts:a,severity:r,setSeverity:s,mlLocator:c,timeBuckets:d,timefilter:l,onSelectEntity:u,showSelectedInterval:b,chartsService:m})=>Object(y.jsx)(n.a.Fragment,null,Object(y.jsx)(i.EuiFlexGroup,{id:e,direction:"row",gutterSize:"l",responsive:!0},Object(y.jsx)(i.EuiFlexItem,{grow:!1},Object(y.jsx)(p.b,{severity:r,onChange:s}))),Object(y.jsx)(i.EuiSpacer,{size:"m"}),Array.isArray(t.seriesToPlot)&&0===t.seriesToPlot.length&&void 0===t.errorMessages&&Object(y.jsx)(i.EuiText,{textAlign:"center","data-test-subj":"mlNoMatchingAnomaliesMessage"},Object(y.jsx)("h4",null,Object(y.jsx)(o.FormattedMessage,{id:"xpack.ml.explorer.noMatchingAnomaliesFoundTitle",defaultMessage:"No matching anomalies found"}))),Object(y.jsx)("div",{className:"euiText explorer-charts"},a&&Object(y.jsx)(g.a,O()({},t,{severity:r.val,mlLocator:c,timeBuckets:d,timefilter:l,onSelectEntity:u,tooManyBucketsCalloutMsg:x,showSelectedInterval:b,chartsService:m}))));var S=a(0),M=a(17),E=a(31),T=a(258);const F=({id:e,embeddableContext:t,embeddableInput:a,services:n,refresh:j,onInputChange:O,onOutputChange:v})=>{var g;const[x,F]=Object(r.useState)(0),[I,_]=Object(r.useState)(Object(p.c)(null!==(g=t.getInput().severityThreshold)&&void 0!==g?g:M.ANOMALY_THRESHOLD.WARNING)),[A,B]=Object(r.useState)(),[{uiSettings:N},{data:k,share:J,uiActions:D,charts:R}]=n,{timefilter:C}=k.query.timefilter,L=Object(r.useMemo)((()=>J.url.locators.get(S.a)),[J]),P=Object(r.useMemo)((()=>new l.a({"histogram:maxBars":N.get(E.UI_SETTINGS.HISTOGRAM_MAX_BARS),"histogram:barTarget":N.get(E.UI_SETTINGS.HISTOGRAM_BAR_TARGET),dateFormat:N.get("dateFormat"),"dateFormat:scaled":N.get("dateFormat:scaled")})),[]);Object(r.useEffect)((()=>{O({severityThreshold:I.val}),v({severity:I.val,entityFields:A})}),[I,A]);const{chartsData:G,isLoading:H,error:V}=function(e,t,a,n,i,o){const[{uiSettings:s},{data:j},{anomalyDetectorService:O,anomalyExplorerService:v}]=n,{timefilter:g}=j.query.timefilter,[p,y]=Object(r.useState)(),[x,w]=Object(r.useState)(),[S,M]=Object(r.useState)(!1),E=Object(r.useMemo)((()=>new c.Subject),[]),T=Object(r.useMemo)((()=>new c.Subject),[]),F=Object(r.useMemo)((()=>new l.a({"histogram:maxBars":s.get(u.UI_SETTINGS.HISTOGRAM_MAX_BARS),"histogram:barTarget":s.get(u.UI_SETTINGS.HISTOGRAM_BAR_TARGET),dateFormat:s.get("dateFormat"),"dateFormat:scaled":s.get("dateFormat:scaled")})),[]);return Object(r.useEffect)((()=>{const t=Object(c.combineLatest)([Object(h.a)(e,O,w),e,E.pipe(Object(d.skipWhile)((e=>!e))),T,a.pipe(Object(d.startWith)(null))]).pipe(Object(d.tap)(M.bind(null,!0)),Object(d.debounceTime)(500),Object(d.switchMap)((([e,t,a,r])=>{var n,i;if(!e)return Object(c.of)(void 0);const{maxSeriesToPlot:o,timeRange:s,filters:l,query:u}=t,h=m.g;let j;v.setTimeRange(s);try{j=Object(f.a)(l,u)}catch(e){return w(e),Object(c.of)(void 0)}const O=v.getTimeBounds(),p={lanes:[m.g],times:[null===(n=O.min)||void 0===n?void 0:n.unix(),null===(i=O.max)||void 0===i?void 0:i.unix()],type:m.h.OVERALL},y=Object(b.i)(p,h),x=Object(b.j)(p,e),S=F.getInterval(),M=Object(b.k)(p,S.asSeconds(),O);return Object(c.forkJoin)({combinedJobs:v.getCombinedJobs(x),anomalyChartRecords:v.loadDataForCharts$(x,M.earliestMs,M.latestMs,y,p,j)}).pipe(Object(d.switchMap)((({combinedJobs:e,anomalyChartRecords:t})=>{const n=e.reduce(((e,t)=>({...e,[t.job_id]:t})),{});return Object(c.forkJoin)({chartsData:Object(c.from)(v.getAnomalyData(void 0,n,a,t,M.earliestMs,M.latestMs,g,r,o))})})))})),Object(d.catchError)((e=>(w(e.body),Object(c.of)(void 0))))).subscribe((e=>{void 0!==e&&(w(null),y(e.chartsData),M(!1))}));return()=>{t.unsubscribe()}}),[]),Object(r.useEffect)((()=>{E.next(i)}),[i]),Object(r.useEffect)((()=>{T.next(o)}),[o]),{chartsData:p,isLoading:S,error:x}}(a,0,j,n,x,I.val),q=Object(r.useCallback)(Object(s.throttle)((e=>{Math.abs(x-e.width)>20&&F(e.width)}),500),[x]);if(V)return Object(y.jsx)(i.EuiCallOut,{title:Object(y.jsx)(o.FormattedMessage,{id:"xpack.ml.anomalyChartsEmbeddable.errorMessage",defaultMessage:"Unable to load the ML anomaly explorer data"}),color:"danger",iconType:"alert",style:{width:"100%"}},Object(y.jsx)("p",null,V.message));const z=(e,a,r)=>{const n=[{fieldName:e,fieldValue:a,operation:r}];B(n),D.getTrigger(T.a).exec({embeddable:t,data:n})};return Object(y.jsx)(i.EuiResizeObserver,{onResize:q},(a=>Object(y.jsx)("div",{id:`mlAnomalyExplorerEmbeddableWrapper-${e}`,style:{width:"100%",overflowY:"auto",overflowX:"hidden",padding:"8px"},"data-test-subj":`mlExplorerEmbeddable_${t.id}`,ref:a},H&&Object(y.jsx)(i.EuiText,{textAlign:"center",style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%,-50%)"}},Object(y.jsx)(i.EuiLoadingChart,{size:"xl",mono:!0,"data-test-subj":"mlAnomalyExplorerEmbeddableLoadingIndicator"})),void 0!==G&&!1===H&&Object(y.jsx)(w,{id:e,showCharts:!0,chartsData:G,severity:I,setSeverity:_,mlLocator:L,timeBuckets:P,timefilter:C,onSelectEntity:z,showSelectedInterval:!1,chartsService:R}))))};t.default=F},96:function(e,t,a){"use strict";a.d(t,"a",(function(){return s})),a.d(t,"h",(function(){return c})),a.d(t,"e",(function(){return d})),a.d(t,"d",(function(){return l})),a.d(t,"c",(function(){return u})),a.d(t,"b",(function(){return b})),a.d(t,"f",(function(){return m})),a.d(t,"i",(function(){return f})),a.d(t,"g",(function(){return h}));var r=a(2),n=a(26);let i=[],o=null;async function s(e){o=e}function c(){return Object(n.i)().find({type:"search",perPage:1e4}).then((e=>(i=e.savedObjects,i)))}async function d(){if(null===o)throw new Error("Data views are not initialized!");return(await o.getIdsWithTitle()).map((({title:e})=>e))}async function l(e){var t;if(null===o)throw new Error("Data views are not initialized!");const a=(await o.find(e)).find((({title:t})=>t===e));return a?null!==(t=a.id)&&void 0!==t?t:a.title:null}function u(e){if(null===o)throw new Error("Data views are not initialized!");return e?o.get(e):o.create({})}async function b(e){var t;const a={savedSearch:null,dataView:null};if(void 0===e)return a;const r=await async function(e){const t=Object(n.i)(),a=await t.get("search",e);return void 0===a.error?a:null}(e);if(null===r)return a;const i=null===(t=r.references.find((e=>"index-pattern"===e.type)))||void 0===t?void 0:t.id;return a.dataView=await u(i),a.savedSearch=r,a}function m(e){const t=e.attributes.kibanaSavedObjectMeta;return JSON.parse(t.searchSourceJSON)}function f(e,t=!1){if(e.isTimeBased())return!0;if(t){Object(n.l)().addWarning({title:r.i18n.translate("xpack.ml.dataViewNotBasedOnTimeSeriesNotificationTitle",{defaultMessage:"The data view {dataViewName} is not based on a time series",values:{dataViewName:e.title}}),text:r.i18n.translate("xpack.ml.dataViewNotBasedOnTimeSeriesNotificationDescription",{defaultMessage:"Anomaly detection only runs over time-based indices"})})}return!1}function h(e){return e.includes(":")}}}]);