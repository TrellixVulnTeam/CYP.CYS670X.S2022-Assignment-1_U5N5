/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements. 
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[22],{207:function(e,t,s){"use strict";s.r(t),s.d(t,"AnomalyTimelineService",(function(){return AnomalyTimelineService}));var a=s(5),i=s.n(a),l=s(47),n=s(110),r=s(85),o=s(17);class AnomalyTimelineService{constructor(e,t,s){i()(this,"timeBuckets",void 0),i()(this,"_customTimeRange",void 0),this.timeFilter=e,this.mlResultsService=s,this.timeBuckets=new n.a({"histogram:maxBars":t.get(l.UI_SETTINGS.HISTOGRAM_MAX_BARS),"histogram:barTarget":t.get(l.UI_SETTINGS.HISTOGRAM_BAR_TARGET),dateFormat:t.get("dateFormat"),"dateFormat:scaled":t.get("dateFormat:scaled")}),this.timeFilter.enableTimeRangeSelector()}static isSwimlaneData(e){return Object(o.isPopulatedObject)(e,["interval","points","laneLabels"])}static isOverallSwimlaneData(e){return this.isSwimlaneData(e)&&Object(o.isPopulatedObject)(e,["earliest","latest"])&&1===e.laneLabels.length&&e.laneLabels[0]===r.g}setTimeRange(e){this._customTimeRange=e}getSwimlaneBucketInterval(e,t){const s=this.getTimeBounds();if(void 0===s)throw new Error("timeRangeSelectorEnabled has to be enabled");this.timeBuckets.setInterval("auto"),this.timeBuckets.setBounds(s);const a=this.timeBuckets.getInterval().asSeconds(),i=(s.max.valueOf()-s.min.valueOf())/1e3/a;Math.floor(t/i*100)/100<8&&this.timeBuckets.setInterval(2*a+"s");const l=e.reduce(((e,t)=>Math.max(e,t.bucketSpanSeconds)),0);return l>a&&(this.timeBuckets.setInterval(l+"s"),this.timeBuckets.setBounds(s)),this.timeBuckets.getInterval()}async loadOverallData(e,t,s,a){const i=null!=s?s:this.getSwimlaneBucketInterval(e,t);if(!e||!e.length)throw new Error("Explorer jobs collection is required");const l=this.getTimeBounds(),r=Object(n.b)(l,i,!1),o=e.map((e=>e.id)),c=Object(n.b)(l,i,!0),u=await this.mlResultsService.getOverallBucketScores(o,1,c.min.valueOf(),c.max.valueOf(),i.asSeconds()+"s",a);return this.processOverallResults(u.results,r,i.asSeconds())}async loadViewBySwimlane(e,t,s,a,i,l,o,c,u,m,h){const d=this.getTimeBounds();if(void 0===d)throw new Error("timeRangeSelectorEnabled has to be enabled");const v=null!=m?m:this.getSwimlaneBucketInterval(s,c),S=Object(n.b)(d,v,!1),b=s.map((e=>e.id)),g=v.asMilliseconds();let f;if(a===r.j){const t=void 0!==e&&e.length>0?e:b;f=await this.mlResultsService.getScoresByBucket(t,S.min.valueOf(),S.max.valueOf(),g,l,o,h)}else f=await this.mlResultsService.getInfluencerValueMaxScoreByTime(b,a,e,S.min.valueOf(),S.max.valueOf(),g,i,l,o,u,h);if(void 0===f)return;return this.processViewByResults(f.results,f.cardinality,e,t,a,v.asSeconds())}async loadViewByTopFieldValuesForSelectedTime(e,t,s,a,i,l,n,o,c,u){const m=s.map((e=>e.id));if(a!==r.j){const s=await this.mlResultsService.getTopInfluencers(m,e,t,i,l,n,c,u);if(void 0===s.influencers[a])return[];const r=[],o=s.influencers[a];return Array.isArray(o)&&o.forEach((e=>{e.maxAnomalyScore>0&&r.push(e.influencerFieldValue)})),r}{const a=await this.mlResultsService.getScoresByBucket(m,e,t,this.getSwimlaneBucketInterval(s,o).asMilliseconds(),l,n,i);return Object.keys(a.results)}}getTimeBounds(){return void 0!==this._customTimeRange?this.timeFilter.calculateBounds(this._customTimeRange):this.timeFilter.getBounds()}processOverallResults(e,t,s){const a=r.g,i={laneLabels:[a],points:[],interval:s,earliest:t.min.valueOf()/1e3,latest:t.max.valueOf()/1e3};return Object.entries(e).forEach((([e,t])=>{const s=+e/1e3;i.points.push({laneLabel:a,time:s,value:t}),i.earliest=Math.min(s,i.earliest),i.latest=Math.max(s+i.interval,i.latest)})),i}processViewByResults(e,t,s,a,i,l){const n={fieldName:i,points:[],laneLabels:[],interval:l,earliest:a.earliest,latest:a.latest,cardinality:t},r={};Object.entries(e).forEach((([e,t])=>{n.laneLabels.push(e),r[e]=0,Object.entries(t).forEach((([t,s])=>{const a=+t/1e3;n.points.push({laneLabel:e,time:a,value:s}),r[e]=Math.max(r[e],s)}))}));const o=s.length;return n.laneLabels=0===o?n.laneLabels.sort(((e,t)=>r[t]-r[e])):n.laneLabels.sort(((e,t)=>{let a=s.indexOf(e),i=s.indexOf(t);return a=a>-1?a:o,i=i>-1?i:o,a-i})),n}}}}]);